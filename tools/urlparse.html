<div class="tool unfocused" id="urlparse" data-tag="urlparse">
	<div class="preview"><h1>Parse URL</h1></div>
	<div class="controls smaller">
		<section id="urlparse-url">
			<label for="urlparse-url-in">URL</label>
			<input type="text" id="urlparse-url-in" spellcheck="false" autofocus>
			<div class="undercontrols">
				<p class="error"><i class="fas fa-exclamation-circle"></i><span>&nbsp;</span></p>
			</div>
		</section>

		<section id="urlparse-fields">
			<div class="fields">
			</div>
		</section>
	</div>

	<script>
		class TURLParser extends Tool {
			constructor(id) {
				super(id);
				this.URL = this.Section("url").Input();

				this.URL.oninput = () => {
					let fields = this.$(".fields")[0];
					while (fields.firstChild)
						fields.removeChild(fields.firstChild);

					let url;

					try {
						url = new URL(this.URL.value);
						this.Section("url").Error(undefined);
						this.Section('fields').Show();
					} catch (err) {
						this.Section("url").Error(err.message);
						this.Section('fields').Hide();
						return;
					}
					
					if (url.protocol) {
						fields.appendChild(this.Component("urlprop", "Protocol", url.protocol));
					}

					if (url.hostname) {
						fields.appendChild(this.Component("urlprop", "Domain", url.hostname));
					}

					if (url.username) {
						fields.appendChild(this.Component("urlprop", "Username", url.username));
					}

					if (url.password) {
						fields.appendChild(this.Component("urlprop", "Password", url.password));
					}

					if (url.path) {
						fields.appendChild(this.Component("urlprop", "Path", url.path));
					} else if (url.pathname) {
						fields.appendChild(this.Component("urlprop", "Path", url.pathname));
					}

					if (url.port) {
						fields.appendChild(this.Component("urlprop", "Port", url.port));
					}

					if (url.hash) {
						fields.appendChild(this.Component("urlprop", "Hash", url.hash));
					}

					/* if (url.search) {
						fields.appendChild(this.Component("urlprop", "Query string", url.search));
					} */
					
					if (url.search && url.searchParams) {
						fields.appendChild(this.Component("section", "Query"));
						let sp = this.improveSearchParams(url.searchParams);
						for (let spn in sp) {
							let spv = sp[spn];
							if (spv instanceof Array) {
								let t = true;
								for (let spvv of spv) {
									fields.appendChild(this.Component("urlprop-sub", t ? (t = false, spn) : "", spvv));
								}
							} else {
								fields.appendChild(this.Component("urlprop-sub", spn, spv));
							}
						}
					}
				};
			}
			
			improveSearchParams(urlsp) {
				let res = {};
				for (let e of urlsp.entries()) {
					let qspn = e[0];
					let qspv = e[1];

					if (qspn.substr(-2) == '[]') {
						qspn = qspn.substr(0, qspn.length - 2);
						res[qspn] || (res[qspn] = []);
						res[qspn].push(qspv);
					} else {
						res[qspn] = qspv;
					}
				}

				return res;
			}
		}

		bench.add(new TURLParser("urlparse"));
		
	</script>

	<div class="components">
		<div class="urlprop kvpair">
			<span class="label" data-arg="0"></span>
			<span class="value copy" data-arg="1"></span>
		</div>
		
		<div class="kvpair section">
			<span class="label" data-arg="0"></span>
			<span class="value">&nbsp;</span>
		</div>
		
		<div class="urlprop-sub kvpair sub">
			<span class="label" data-arg="0"></span>
			<span class="value copy" data-arg="1"></span>
		</div>
	</div>
</div>